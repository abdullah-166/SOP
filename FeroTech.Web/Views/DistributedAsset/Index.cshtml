@model IEnumerable<FeroTech.Infrastructure.Application.DTOs.DistributedAssetListDto>

@{
    ViewData["Title"] = "Assigned Assets";

    var grouped = Model
        .GroupBy(x => new { x.EmployeeId, x.EmployeeName, x.EmployeePhone })
        .ToList();
}

<h2 class="mb-3">Assigned Assets</h2>

<div class="row mb-3">
    <div class="col-md-4">
        <!-- SEARCHBAR -->
        <input type="text"
               id="customSearch"
               class="form-control"
               placeholder="Search employee, phone, asset, category, date..." />
    </div>

    <div class="col-md-8 text-end">
        <a href="/DistributedAsset/Create" class="btn btn-success">+ Assign New Asset</a>
    </div>
</div>

<table id="groupedTable" class="table table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Employee</th>
            <th>Phone</th>
            <th>Asset</th>
            <th>Category</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Action</th>
        </tr>
    </thead>

    <tbody>
        @foreach (var group in grouped)
        {
            int rowSpan = group.Count();
            bool first = true;

            foreach (var item in group)
            {
                <tr>
                    @if (first)
                    {
                        <td rowspan="@rowSpan" class="fw-bold">@group.Key.EmployeeName</td>
                        <td rowspan="@rowSpan">@group.Key.EmployeePhone</td>
                        first = false;
                    }

                    <td>@item.AssetName</td>
                    <td>@item.CategoryName</td>
                    <td>@item.AssignedDate.ToString("MM/dd/yyyy")</td>
                    <td>@(item.EndDate?.ToString("MM/dd/yyyy") ?? "-")</td>

                    <td>
                        <a href="/DistributedAsset/Edit/@item.DistributedAssetId" class="btn btn-primary btn-sm">Edit</a>
                        <button type="button"
                                class="btn btn-danger btn-sm deleteBtn"
                                data-id="@item.DistributedAssetId">
                            Delete
                        </button>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {

            // 🔍 SIMPLE CLIENT-SIDE SEARCH (no DataTables, safe with rowspan)
            $("#customSearch").on("keyup", function () {
                let value = $(this).val().toLowerCase();

                if (!value) {
                    // Show all rows if search is empty
                    $("#groupedTable tbody tr").show();
                    return;
                }

                $("#groupedTable tbody tr").each(function () {
                    let rowText = $(this).text().toLowerCase();
                    $(this).toggle(rowText.indexOf(value) > -1);
                });
            });

            // 🗑️ WORKING DELETE BUTTON (plain jQuery + AJAX)
            $(document).on("click", ".deleteBtn", function () {
                let id = $(this).data("id");

                Swal.fire({
                    title: "Are you sure?",
                    text: "This assigned asset will be deleted!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Delete"
                }).then(result => {
                    if (result.isConfirmed) {

                        $.ajax({
                            url: "/DistributedAsset/Delete",
                            type: "POST",
                            data: { id: id },

                            success: function (response) {
                                if (response.success) {
                                    Swal.fire("Deleted!", response.message, "success")
                                        .then(() => {
                                            // reload page so rowspan/employee grouping is recalculated
                                            window.location.reload();
                                        });
                                } else {
                                    Swal.fire("Error", response.message, "error");
                                }
                            },

                            error: function () {
                                Swal.fire("Error", "Delete request failed!", "error");
                            }
                        });
                    }
                });
            });

        });
    </script>
}