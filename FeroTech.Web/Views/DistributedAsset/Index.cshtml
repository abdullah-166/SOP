@model IEnumerable<FeroTech.Infrastructure.Application.DTOs.DistributedAssetListDto>

@{
    ViewData["Title"] = "Assigned Assets";

    var grouped = Model
        .GroupBy(x => new { x.EmployeeId, x.EmployeeName, x.EmployeePhone })
        .ToList();
}

<h2 class="mb-3">Assigned Assets</h2>

<div class="text-end mb-3">
    <a href="/DistributedAsset/Create" class="btn btn-success">+ Assign New Asset</a>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />

<table id="groupedTable" class="table table-bordered display">
    <thead class="table-dark">
        <tr>
            <th>Employee</th>
            <th>Phone</th>
            <th>Asset</th>
            <th>Category</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Action</th>
        </tr>
    </thead>

    <tbody>
        @foreach (var group in grouped)
        {
            int rowSpan = group.Count();
            bool first = true;

            foreach (var item in group)
            {
                <tr>
                    @if (first)
                    {
                        <td rowspan="@rowSpan" class="fw-bold">@group.Key.EmployeeName</td>
                        <td rowspan="@rowSpan">@group.Key.EmployeePhone</td>
                        first = false;
                    }

                    <td>@item.AssetName</td>
                    <td>@item.CategoryName</td>

                    <!-- UPDATED DATE FORMAT -->
                    <td>@item.AssignedDate.ToString("MM/dd/yyyy")</td>
                    <td>@(item.EndDate?.ToString("MM/dd/yyyy") ?? "-")</td>

                    <td>
                        <a href="/DistributedAsset/Edit/@item.DistributedAssetId" class="btn btn-primary btn-sm">Edit</a>
                        <button class="btn btn-danger btn-sm deleteBtn" data-id="@item.DistributedAssetId">Delete</button>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Disable DataTables error popup for rowspan tables
        $.fn.dataTable.ext.errMode = 'none';

        $(document).ready(function () {

            $("#groupedTable").DataTable({
                paging: true,
                searching: true,
                ordering: false,
                info: false,
                autoWidth: false,
                responsive: false
            });

            // DELETE BUTTON
            $(document).on("click", ".deleteBtn", function () {
                let id = $(this).data("id");

                Swal.fire({
                    title: "Are you sure?",
                    text: "This assignment will be removed",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Delete"
                }).then(res => {
                    if (res.isConfirmed) {
                        $.post("/DistributedAsset/Delete", { id: id }, function (response) {
                            if (response.success) {
                                Swal.fire("Deleted!", response.message, "success")
                                    .then(() => location.reload());
                            } else {
                                Swal.fire("Error", response.message, "error");
                            }
                        });
                    }
                });
            });

        });
    </script>
}
