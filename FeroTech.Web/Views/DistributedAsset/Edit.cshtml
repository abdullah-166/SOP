@removeTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model FeroTech.Infrastructure.Domain.Entities.DistributedAsset

@{
    var employees = ViewBag.EmployeeList as IEnumerable<FeroTech.Infrastructure.Application.DTOs.EmployeeDto>;
    var categories = ViewBag.CategoryList as IEnumerable<FeroTech.Infrastructure.Application.DTOs.CategoryDto>;
    var assets = ViewBag.AssetList as IEnumerable<FeroTech.Infrastructure.Domain.Entities.Asset>;
}

<h2>Edit Assigned Asset</h2>
<hr />

<form id="editForm">
    <input type="hidden" name="DistributedAssetId" value="@Model.DistributedAssetId" />

    <div class="row">

        <!-- EMPLOYEE -->
        <div class="col-md-6 mb-3">
            <label>Employee</label>
            <select name="EmployeeId" id="EmployeeId" class="form-select">
                @foreach (var emp in employees)
                {
                    <option value="@emp.EmployeeId" @(emp.EmployeeId == Model.EmployeeId ? "selected" : "")>
                        @emp.FullName (@emp.Phone)
                    </option>
                }
            </select>
        </div>

        <!-- CATEGORY -->
        <div class="col-md-6 mb-3">
            <label>Category</label>
            <select name="CategoryId" id="CategoryId" class="form-select">
                @foreach (var cat in categories)
                {
                    <option value="@cat.CategoryId" @(cat.CategoryId == Model.CategoryId ? "selected" : "")>
                        @cat.CategoryName
                    </option>
                }
            </select>
        </div>

        <!-- ASSET -->
        <div class="col-md-6 mb-3">
            <label>Asset</label>
            <select name="AssetId" id="AssetId" class="form-select">
                @foreach (var a in assets)
                {
                    <option value="@a.AssetId" @(a.AssetId == Model.AssetId ? "selected" : "")>
                        @a.Brand @a.Modell
                    </option>
                }
            </select>
        </div>

        <!-- DATES -->
        <div class="col-md-6 mb-3">
            <label>Assigned Date</label>
            <input name="AssignedDate" type="date" class="form-control"
                   value="@((Model.AssignedDate == DateTime.MinValue ? DateTime.Today : Model.AssignedDate).ToString("yyyy-MM-dd"))" />
        </div>

        <div class="col-md-6 mb-3">
            <label>End Date</label>
            <input name="EndDate" type="date" class="form-control"
                   value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
        </div>

        <div class="col-md-12 mb-3">
            <label>Notes</label>
            <textarea name="Notes" class="form-control">@Model.Notes</textarea>
        </div>

        <div class="col-md-12 text-end">
            <button type="submit" class="btn btn-primary">Update</button>
        </div>

    </div>
</form>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {

            // When category changes → reload assets
            $("#CategoryId").change(function () {
                let id = $(this).val();

                $.get("/DistributedAsset/GetAssetsByCategory", { categoryId: id }, function (data) {
                    $("#AssetId").empty().append('<option value="">-- Select Asset --</option>');
                    data.forEach(a => {
                        $("#AssetId").append(`<option value="${a.assetId}">${a.name}</option>`);
                    });
                });
            });

            // Submit update form
            $("#editForm").submit(function (e) {
                e.preventDefault();

                $.ajax({
                    url: "/DistributedAsset/Edit",
                    type: "POST",
                    data: $(this).serialize(),
                    success: function (res) {
                        if (res.success) {
                            Swal.fire("Updated!", res.message, "success")
                                .then(() => window.location.href = "/DistributedAsset/Index");
                        } else {
                            Swal.fire("Error", res.message, "error");
                        }
                    }
                });
            });

        });
    </script>
}
